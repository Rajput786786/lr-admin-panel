<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR Owner Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f1a;color:white;}
header{padding:20px;text-align:center;font-size:24px;background:#111;color:#00ffff;}
.container{padding:20px;}
.card{background:#1a1a2e;padding:20px;border-radius:10px;margin-bottom:20px;}
input{padding:10px;margin:5px 0;width:100%;border:none;border-radius:5px;}
button{padding:10px;margin-top:10px;border:none;border-radius:5px;font-weight:bold;cursor:pointer;}
.main-btn{width:100%;background:#00ffff;color:black;}
.block-btn{background:#999;color:black;}
.delete-btn{background:red;color:white;margin-left:5px;}
.logout-btn{background:red;color:white;width:100%;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #333;}
.status-active{color:#00ff88;}
.status-block{color:red;}
</style>
</head>

<body>

<header>LR OWNER PANEL</header>

<div class="container">

<div class="card" id="loginSection">
<h3>Login</h3>
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button class="main-btn" onclick="login()">Login</button>
</div>

<div id="mainPanel" style="display:none;">

<div class="card">
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="card">
<h3>Generate License Key</h3>

<input type="text" id="username" placeholder="User Name">
<input type="text" id="customKey" placeholder="Custom Key (optional)">
<input type="number" id="hours" placeholder="Validity (Hours)">
<input type="number" id="days" placeholder="Validity (Days)">

<button class="main-btn" onclick="generateKey()">Generate Key</button>
</div>

<div class="card">
<h3>Active Keys</h3>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="keyTable"></tbody>
</table>
</div>

</div>
</div>

<script>

const { createClient } = supabase;

const client = createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"YOUR_ANON_KEY_HERE"
);

document.addEventListener("DOMContentLoaded", async () => {
const { data } = await client.auth.getSession();
if(data.session){
await checkOwner(data.session.user.id);
}
});

async function login(){
let email=document.getElementById("loginEmail").value.trim();
let password=document.getElementById("loginPassword").value.trim();

if(!email||!password){alert("Enter Email & Password");return;}

const { data,error }=await client.auth.signInWithPassword({email,password});
if(error){alert(error.message);return;}

await checkOwner(data.user.id);
}

async function checkOwner(uid){
const { data,error }=await client.from("profiles").select("role").eq("id",uid).single();

if(error||!data){alert("Profile not found");await client.auth.signOut();return;}

if(data.role!=="owner"){alert("Owner Only");await client.auth.signOut();return;}

showPanel();
loadKeys();
}

async function logout(){
await client.auth.signOut();
location.reload();
}

function showPanel(){
document.getElementById("loginSection").style.display="none";
document.getElementById("mainPanel").style.display="block";
}

function randomKey(){
return "LR-"+Math.floor(Math.random()*1000000);
}

async function generateKey(){

let user=document.getElementById("username").value.trim();
let customKey=document.getElementById("customKey").value.trim();
let hours=parseInt(document.getElementById("hours").value);
let days=parseInt(document.getElementById("days").value);

if(!user){alert("Enter Username");return;}

if(isNaN(hours)&&isNaN(days)){alert("Enter Hours or Days");return;}

let key=customKey?customKey:randomKey();

let now=new Date();
let expireDate=new Date(now);

if(!isNaN(hours)){
expireDate.setTime(now.getTime() + hours*60*60*1000);
}else{
expireDate.setTime(now.getTime() + days*24*60*60*1000);
}

const { error }=await client.from("license_keys").insert([{
username:user,
license_key:key,
expire_date:expireDate.toISOString(),
status:"Active"
}]);

if(error){alert(error.message);return;}

loadKeys();

document.getElementById("username").value="";
document.getElementById("customKey").value="";
document.getElementById("hours").value="";
document.getElementById("days").value="";
}

async function loadKeys(){
let { data,error }=await client.from("license_keys").select("*").order("id",{ascending:false});
if(error){alert(error.message);return;}

let table=document.getElementById("keyTable");
table.innerHTML="";

data.forEach(k=>{
table.innerHTML+=`
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${new Date(k.expire_date).toLocaleString('en-IN',{
timeZone:'Asia/Kolkata',
hour12:true
})}</td>
<td class="${k.status=="Active"?"status-active":"status-block"}">${k.status}</td>
<td>
<button class="block-btn" onclick="toggleStatus(${k.id},'${k.status}')">
${k.status=="Active"?"Block":"Unblock"}
</button>
<button class="delete-btn" onclick="deleteKey(${k.id})">
Delete
</button>
</td>
</tr>`;
});
}

async function toggleStatus(id,current){
let newStatus=current=="Active"?"Blocked":"Active";
await client.from("license_keys").update({status:newStatus}).eq("id",id);
loadKeys();
}

async function deleteKey(id){
if(!confirm("Delete this key permanently?")) return;

await client.from("license_keys").update({status:"Blocked"}).eq("id",id);
await client.from("license_keys").delete().eq("id",id);

loadKeys();
}

</script>

</body>
</html>
