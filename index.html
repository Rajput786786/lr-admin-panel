<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR CONTROL PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f1a;color:white;}
header{padding:20px;text-align:center;font-size:28px;font-weight:bold;background:#111;color:#00f5ff;letter-spacing:2px;}
.container{padding:20px;}
.card{background:#151528;padding:20px;border-radius:14px;margin-bottom:25px;box-shadow:0 0 25px #00f5ff33;}
input,select{padding:10px;margin:6px 0;width:100%;border:none;border-radius:6px;background:#0d0d18;color:white;}
button{padding:10px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin-top:8px;}
.owner-btn{background:#00f5ff;color:black;width:100%;}
.admin-btn{background:#00ff9d;color:black;width:100%;}
.block-btn{background:#888;color:black;}
.delete-btn{background:red;color:white;margin-left:5px;}
.logout-btn{background:red;color:white;width:100%;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #222;}
.status-active{color:#00ff9d;}
.status-block{color:red;}
.hidden{display:none;}
.admin-title{color:#00ff9d;font-weight:bold;font-size:22px;}
.balance-box{float:right;color:#00ff9d;font-size:14px;text-align:right;}
.clear{clear:both;}
</style>
</head>

<body>

<header>LR CONTROL PANEL</header>

<div class="container">

<div class="card" id="loginSection">
<h3>Login</h3>
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button class="owner-btn" onclick="login()">Login</button>
</div>

<div id="mainPanel" class="hidden">

<div class="card">
<button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- OWNER PANEL -->
<div class="card hidden" id="ownerPanel">
<h2 style="color:#00f5ff;">LR OWNER PANEL</h2>

<input type="text" id="ownerUser" placeholder="User">
<input type="text" id="ownerManualKey" placeholder="Manual Key (Optional)">
<input type="number" id="ownerValidity" placeholder="Validity">
<select id="ownerType">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button class="owner-btn" onclick="generateKey('owner')">Generate Key</button>

<h3 style="margin-top:25px;">Owner Keys</h3>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="ownerKeys"></tbody>
</table>

<h3 style="margin-top:40px;">Admins</h3>
<div id="adminSections"></div>

<h3 style="margin-top:40px;">Add New Admin</h3>
<input type="email" id="newAdminEmail" placeholder="Admin Email">
<input type="password" id="newAdminPass" placeholder="Admin Password">
<button class="owner-btn" onclick="createAdmin()">Create Admin</button>

</div>

<!-- ADMIN PANEL -->
<div class="card hidden" id="adminPanel">

<div style="display:flex;justify-content:space-between;">
<h2 class="admin-title">ADMIN PANEL</h2>
<div class="balance-box" id="adminBalanceBox"></div>
</div>
<div class="clear"></div>

<input type="text" id="adminUser" placeholder="User">
<input type="text" id="adminManualKey" placeholder="Manual Key (Optional)">
<input type="number" id="adminValidity" placeholder="Validity">
<select id="adminType">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button class="admin-btn" onclick="generateKey('admin')">Generate Key</button>

<h3 style="margin-top:25px;">Your Keys</h3>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="adminKeys"></tbody>
</table>

</div>

</div>
</div>

<script>

const { createClient } = supabase;

const client = createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs"
);

let currentUser;
let currentRole;

document.addEventListener("DOMContentLoaded", async () => {
const { data } = await client.auth.getSession();
if(data.session){ initUser(); }
});

async function login(){
const { error } = await client.auth.signInWithPassword({
email:loginEmail.value,
password:loginPassword.value
});
if(error){ alert(error.message); return; }
initUser();
}

async function initUser(){
const { data:{user} } = await client.auth.getUser();
currentUser=user;

let { data } = await client.from("profiles")
.select("*")
.eq("id",user.id)
.single();

currentRole=data.role;

loginSection.style.display="none";
mainPanel.classList.remove("hidden");

if(currentRole==="owner"){
ownerPanel.classList.remove("hidden");
loadOwnerData();
}else{
adminPanel.classList.remove("hidden");
loadAdminData();
}
}

async function logout(){
await client.auth.signOut();
location.reload();
}

function randomKey(){
return "LR-"+Math.floor(100000+Math.random()*900000);
}

async function generateKey(type){

let user, manualKey, validity, unit;

if(type==="owner"){
user=ownerUser.value;
manualKey=ownerManualKey.value;
validity=ownerValidity.value;
unit=ownerType.value;
}else{
user=adminUser.value;
manualKey=adminManualKey.value;
validity=adminValidity.value;
unit=adminType.value;
}

if(!user||!validity){alert("Fill fields");return;}

let expire=new Date();

if(unit==="days"){
expire.setDate(expire.getDate()+parseInt(validity));
}else{
expire.setHours(expire.getHours()+parseInt(validity));
}

let cost = unit==="days" ? validity*100 : validity*10;

if(type==="admin"){
let { data } = await client.from("profiles").select("balance").eq("id",currentUser.id).single();
if(data.balance < cost){ alert("Insufficient Balance"); return; }
await client.from("profiles").update({balance:data.balance-cost}).eq("id",currentUser.id);
}

await client.from("license_keys").insert([{
username:user,
license_key:manualKey?manualKey:randomKey(),
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

if(type==="owner") loadOwnerData(); else loadAdminData();
}

async function loadOwnerData(){

// Owner keys
let { data:ownerKeysData } = await client.from("license_keys")
.select("*")
.eq("created_by",currentUser.id)
.order("id",{ascending:false});

ownerKeys.innerHTML="";
ownerKeysData.forEach(k=>{
ownerKeys.innerHTML+=rowTemplate(k);
});

// Admin sections
let { data:admins } = await client.from("profiles").select("*").eq("role","admin");

adminSections.innerHTML="";

for(let admin of admins){

let { data:adminKeysData } = await client.from("license_keys")
.select("*")
.eq("created_by",admin.id);

let active=adminKeysData.filter(k=>k.status==="Active").length;
let blocked=adminKeysData.filter(k=>k.status==="Blocked").length;

let section=`
<div class="card">
<div style="display:flex;justify-content:space-between;">
<div>
<b>${admin.email}</b><br>
Balance: ${admin.balance}<br>
Total: ${adminKeysData.length} | Active: ${active} | Blocked: ${blocked}
</div>
<div>
<button class="block-btn" onclick="blockAdmin('${admin.id}')">Block</button>
<button class="delete-btn" onclick="deleteAdmin('${admin.id}')">Delete</button>
</div>
</div>

<table>
<tr><th>User</th><th>Key</th><th>Expire</th><th>Status</th></tr>
`;

adminKeysData.forEach(k=>{
section+=`
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${new Date(k.expire_date).toLocaleString("en-IN",{hour12:true})}</td>
<td>${k.status}</td>
</tr>`;
});

section+=`</table></div>`;
adminSections.innerHTML+=section;
}

}

async function loadAdminData(){

let { data:keys } = await client.from("license_keys")
.select("*")
.eq("created_by",currentUser.id)
.order("id",{ascending:false});

adminKeys.innerHTML="";
keys.forEach(k=>{
adminKeys.innerHTML+=rowTemplate(k);
});

let { data:profile } = await client.from("profiles").select("*").eq("id",currentUser.id).single();
let active=keys.filter(k=>k.status==="Active").length;
let blocked=keys.filter(k=>k.status==="Blocked").length;

adminBalanceBox.innerHTML=`Balance: ${profile.balance}<br>Total: ${keys.length} | Active: ${active} | Blocked: ${blocked}`;
}

function rowTemplate(k){
return `
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${new Date(k.expire_date).toLocaleString("en-IN",{hour12:true})}</td>
<td class="${k.status==="Active"?"status-active":"status-block"}">${k.status}</td>
<td>
<button class="block-btn" onclick="toggleStatus(${k.id},'${k.status}')">
${k.status==="Active"?"Block":"Unblock"}
</button>
<button class="delete-btn" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>`;
}

async function toggleStatus(id,current){
let newStatus=current==="Active"?"Blocked":"Active";
await client.from("license_keys").update({status:newStatus}).eq("id",id);
currentRole==="owner"?loadOwnerData():loadAdminData();
}

async function deleteKey(id){
if(!confirm("Delete?"))return;
await client.from("license_keys").delete().eq("id",id);
currentRole==="owner"?loadOwnerData():loadAdminData();
}

async function createAdmin(){
let email=newAdminEmail.value;
let pass=newAdminPass.value;
if(!email||!pass){alert("Fill fields");return;}

const { data, error } = await client.auth.admin.createUser({
email:email,
password:pass
});

if(error){alert(error.message);return;}

await client.from("profiles").insert([{
id:data.user.id,
role:"admin",
balance:1000
}]);

loadOwnerData();
}

async function blockAdmin(adminId){
await client.from("license_keys").update({status:"Blocked"}).eq("created_by",adminId);
loadOwnerData();
}

async function deleteAdmin(adminId){
if(!confirm("Delete Admin?"))return;
await client.from("license_keys").delete().eq("created_by",adminId);
await client.from("profiles").delete().eq("id",adminId);
loadOwnerData();
}

</script>

</body>
  </html>
