<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LR Owner - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        * { font-family: 'Orbitron', monospace; }
        .glass { backdrop-filter: blur(20px); background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .glow-cyan { box-shadow: 0 0 30px rgba(0,255,255,0.5); }
        .gradient-bg { 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a0033 50%, #000428 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="gradient-bg text-white p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-12">
            <h1 class="text-5xl font-black glow-cyan text-cyan-400 drop-shadow-2xl">LR OWNER PANEL</h1>
            <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-full text-xl font-bold glow-cyan transition-all duration-300">
                LOG OUT
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center text-xl glow-cyan">Loading Dashboard...</div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="space-y-12 hidden">
            <!-- Owner Keys Section -->
            <div id="ownerKeysSection" class="glass p-8 rounded-3xl glow-cyan">
                <h2 class="text-4xl font-bold text-cyan-400 mb-6 flex items-center">
                    <span class="w-3 h-3 bg-green-400 rounded-full mr-3"></span>
                    OWNER KEYS (Unlimited)
                </h2>
                <div id="ownerKeysList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Admin Sections -->
            <div id="adminSections"></div>

            <!-- Add New Admin -->
            <div class="glass p-8 rounded-3xl glow-cyan text-center">
                <h3 class="text-3xl font-bold text-white mb-8">➕ ADD NEW ADMIN</h3>
                <div class="flex flex-col lg:flex-row gap-4 max-w-2xl mx-auto">
                    <input id="newAdminEmail" type="email" placeholder="admin@example.com" 
                           class="flex-1 bg-black/30 border border-cyan-500/50 rounded-2xl px-6 py-4 text-xl focus:outline-none focus:ring-4 ring-cyan-500/30">
                    <button id="addAdminBtn" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 
                            px-12 py-4 rounded-2xl text-xl font-bold glow-cyan transition-all duration-300">
                        ADD ADMIN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Generation Modal -->
    <div id="keyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="glass p-8 rounded-3xl glow-cyan max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-cyan-400 mb-6">Generate New Key</h3>
            <div class="space-y-4">
                <input id="keyUsername" type="text" placeholder="Username (or random)" class="w-full bg-black/30 border border-cyan-500/50 rounded-xl px-4 py-3">
                <div class="grid grid-cols-2 gap-4">
                    <input id="keyDays" type="number" min="1" max="365" placeholder="Days" class="bg-black/30 border border-cyan-500/50 rounded-xl px-4 py-3">
                    <input id="keyHours" type="number" min="1" max="8760" placeholder="Hours" class="bg-black/30 border border-cyan-500/50 rounded-xl px-4 py-3">
                </div>
                <div class="flex gap-2 text-sm text-gray-300">
                    <label><input type="radio" name="timeType" value="days" checked> Days (₹100/day)</label>
                    <label><input type="radio" name="timeType" value="hours"> Hours (₹10/hour)</label>
                </div>
                <div class="flex gap-3 pt-4">
                    <button id="generateKeyBtn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 px-6 py-3 rounded-xl font-bold glow-cyan">
                        GENERATE
                    </button>
                    <button id="cancelKeyBtn" class="flex-1 bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-xl font-bold">CANCEL</button>
                </div>
                <div id="costPreview" class="text-center text-lg font-bold mt-2"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://dpskhodrzlnqczibolug.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs';
        
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let isOwner = false;

        // Status Colors
        const STATUS_COLORS = {
            'Active': 'bg-green-400',
            'Blocked': 'bg-red-400', 
            'Expired': 'bg-blue-400'
        };

        // Init
        async function init() {
            await checkAuth();
        }

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/login'; // Assume login page exists
                return;
            }

            currentUser = session.user;
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (!profile || profile.status !== 'active' || profile.is_blocked) {
                supabase.auth.signOut();
                alert('Access Denied');
                return;
            }

            isOwner = profile.role === 'owner';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            if (isOwner) {
                loadOwnerDashboard();
            } else {
                loadAdminDashboard();
            }
        }

        // Owner Dashboard
        async function loadOwnerDashboard() {
            // Owner Keys
            const { data: ownerKeys } = await supabase
                .from('license_keys')
                .select('*')
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false });

            renderKeys(ownerKeys, 'ownerKeysList');

            // All Admins
            const { data: admins } = await supabase
                .from('profiles')
                .select('*, license_keys(count)')
                .eq('role', 'admin')
                .eq('status', 'active')
                .neq('is_blocked', true);

            const adminSections = document.getElementById('adminSections');
            adminSections.innerHTML = '';
            
            for (const admin of admins || []) {
                const adminDiv = createAdminSection(admin);
                adminSections.appendChild(adminDiv);
            }
        }

        // Admin Dashboard (Self only)
        async function loadAdminDashboard() {
            document.getElementById('ownerKeysSection').remove();
            document.querySelector('.glass:last-child').remove(); // Remove add admin

            const { data: keys } = await supabase
                .from('license_keys')
                .select('*')
                .eq('created_by', currentUser.id)
                .order('created_at', { ascending: false });

            const { data: profile } = await supabase
                .from('profiles')
                .select('email, balance')
                .eq('id', currentUser.id)
                .single();

            const adminDiv = document.createElement('div');
            adminDiv.className = 'glass p-8 rounded-3xl glow-cyan';
            adminDiv.innerHTML = `
                <h2 class="text-4xl font-bold text-cyan-400 mb-6">आपका Panel</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div>Email: ${profile.email}</div>
                    <div class="text-right">Balance: ₹${profile.balance}</div>
                </div>
                <div id="adminKeysList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            `;
            renderKeys(keys, 'adminKeysList');
            document.getElementById('adminSections').appendChild(adminDiv);
        }

        // Render Keys
        function renderKeys(keys, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            keys.forEach(key => {
                const expireText = new Date(key.expire_date) < new Date() ? 'Expired' : 
                    new Date(key.expire_date).toLocaleString();
                
                const keyDiv = document.createElement('div');
                keyDiv.className = `glass p-6 rounded-2xl border-2 ${STATUS_COLORS[key.status]} border-opacity-50 glow-cyan`;
                keyDiv.innerHTML = `
                    <div class="font-bold text-xl mb-2">${key.username}</div>
                    <div class="text-sm opacity-75 mb-4 font-mono text-xs break-all">${key.license_key}</div>
                    <div class="text-sm opacity-75 mb-4">${expireText}</div>
                    <div class="flex gap-2 text-xs">
                        <span class="px-2 py-1 bg-black/50 rounded-full">${key.key_type}</span>
                        <span>${key.status}</span>
                    </div>
                `;
                container.appendChild(keyDiv);
            });
        }

        // Create Admin Section (Owner Only)
        function createAdminSection(admin) {
            const div = document.createElement('div');
            div.className = 'glass p-8 rounded-3xl glow-cyan';
            div.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <h3 class="text-3xl font-bold text-white">${admin.email}</h3>
                    <div class="text-right">
                        <div>Balance: ₹${admin.balance || 0}</div>
                        <div class="text-sm opacity-75">Total Keys: ${admin.license_keys?.count || 0}</div>
                    </div>
                </div>
                <div id="keys-${admin.id}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>
                <div class="flex gap-4">
                    <button onclick="blockAdmin('${admin.id}')" class="flex-1 bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl font-bold">
                        BLOCK ADMIN
                    </button>
                    <button onclick="deleteAdmin('${admin.id}')" class="flex-1 bg-orange-600 hover:bg-orange-700 px-6 py-3 rounded-xl font-bold">
                        DELETE ADMIN
                    </button>
                    <button onclick="addBalance('${admin.id}')" class="flex-1 bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl font-bold">
                        ADD ₹1000
                    </button>
                </div>
            `;

            // Load admin keys
            loadAdminKeys(admin.id, `keys-${admin.id}`);
            return div;
        }

        // Load Admin Keys
        async function loadAdminKeys(adminId, containerId) {
            const { data: keys } = await supabase
                .from('license_keys')
                .select('*')
                .eq('created_by', adminId)
                .order('created_at', { ascending: false });

            renderKeys(keys, containerId);
        }

        // Generate Key
        document.getElementById('generateKeyBtn').onclick = async () => {
            const username = document.getElementById('keyUsername').value || `user_${Date.now()}`;
            const days = parseInt(document.getElementById('keyDays').value) || 0;
            const hours = parseInt(document.getElementById('keyHours').value) || 0;
            const timeType = document.querySelector('input[name="timeType"]:checked').value;

            let duration = 0;
            let cost = 0;
            let keyType = '';

            if (timeType === 'days' && days > 0) {
                duration = days * 24 * 60 * 60 * 1000;
                cost = days * 100;
                keyType = `${days} Days`;
            } else if (hours > 0) {
                duration = hours * 60 * 60 * 1000;
                cost = hours * 10;
                keyType = `${hours} Hours`;
            }

            if (duration === 0) {
                alert('Days या Hours डालो!');
                return;
            }

            if (!isOwner) {
                const { data: profile } = await supabase.from('profiles').select('balance').eq('id', currentUser.id).single();
                if (profile.balance < cost) {
                    alert(`Insufficient Balance! Need ₹${cost}, Have ₹${profile.balance}`);
                    return;
                }
            }

            const licenseKey = `LR-${Math.random().toString(36).substr(2, 12).toUpperCase()}-${Date.now()}`;
            const expireDate = new Date(Date.now() + duration).toISOString();

            const { data, error } = await supabase
                .from('license_keys')
                .insert({
                    username,
                    license_key: licenseKey,
                    expire_date: expireDate,
                    status: 'Active',
                    created_by: currentUser.id,
                    key_type: keyType
                })
                .select()
                .single();

            if (!isOwner) {
                await supabase.from('profiles').update({ balance: profile.balance - cost }).eq('id', currentUser.id);
            }

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert(`Key Generated!
${licenseKey}
Expires: ${new Date(expireDate).toLocaleString()}`);
                closeKeyModal();
                if (isOwner) loadOwnerDashboard();
                else loadAdminDashboard();
            }
        };

        // UI Events
        document.getElementById('addAdminBtn').onclick = async () => {
            const email = document.getElementById('newAdminEmail').value;
            if (!email) return alert('Email डालो!');

            const { data, error } = await supabase
                .from('profiles')
                .insert({ email, role: 'admin' })
                .select()
                .single();

            if (error) alert('Error: ' + error.message);
            else {
                alert('Admin Added!');
                loadOwnerDashboard();
            }
        };

        document.getElementById('logoutBtn').onclick = () => supabase.auth.signOut();

        // Modal Controls
        document.getElementById('ownerKeysSection')?.addEventListener('click', (e) => {
            if (e.target.id === 'ownerKeysSection' || e.target.tagName === 'H2') openKeyModal();
        });

        function openKeyModal() {
            document.getElementById('keyModal').classList.remove('hidden');
        }

        function closeKeyModal() {
            document.getElementById('keyModal').classList.add('hidden');
            document.getElementById('keyUsername').value = '';
            document.getElementById('keyDays').value = '';
            document.getElementById('keyHours').value = '';
        }

        document.getElementById('cancelKeyBtn').onclick = closeKeyModal;

        // Admin Actions (Owner Only)
        window.blockAdmin = async (adminId) => {
            await supabase.from('profiles').update({ status: 'blocked', is_blocked: true }).eq('id', adminId);
            await supabase.from('license_keys').update({ status: 'Blocked' }).eq('created_by', adminId);
            loadOwnerDashboard();
        };

        window.deleteAdmin = async (adminId) => {
            if (!confirm('Admin + सभी keys permanently delete हो जाएंगे?')) return;
            
            const { error } = await supabase.rpc('delete_admin', { admin_id: adminId });
            if (error) alert('Error: ' + error.message);
            else loadOwnerDashboard();
        };

        window.addBalance = async (adminId) => {
            const { data: profile } = await supabase.from('profiles').select('balance').eq('id', adminId).single();
            const newBalance = Math.min(profile.balance + 1000, 100000);
            await supabase.from('profiles').update({ balance: newBalance }).eq('id', adminId);
            loadOwnerDashboard();
        };

        // Cost Preview
        document.querySelectorAll('input[name="timeType"], #keyDays, #keyHours').forEach(input => {
            input.oninput = () => {
                const days = parseInt(document.getElementById('keyDays').value) || 0;
                const hours = parseInt(document.getElementById('keyHours').value) || 0;
                const timeType = document.querySelector('input[name="timeType"]:checked').value;
                let cost = 0;
                if (timeType === 'days') cost = days * 100;
                else cost = hours * 10;
                document.getElementById('costPreview').textContent = `Cost: ₹${cost}`;
            };
        });

        init();
    </script>
</body>
    </html>
