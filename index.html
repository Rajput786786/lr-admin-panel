<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR CONTROL PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f1a;color:white;}
header{padding:20px;text-align:center;font-size:32px;font-weight:bold;background:#111;color:#00ffff;position:relative;}
.logout-top{
position:absolute;right:20px;top:15px;
background:red;color:white;
padding:10px 18px;border:none;
border-radius:8px;font-weight:bold;cursor:pointer;
}
.container{padding:20px;max-width:1200px;margin:auto;}
.card{background:#151528;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:0 0 25px #00f5ff22;}
input,select{padding:10px;margin:6px 0;width:100%;border:none;border-radius:6px;background:#0d0d18;color:white;}
button{padding:8px 14px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;}
.owner-btn{background:#00f5ff;color:black;}
.danger-btn{background:red;color:white;}
.block-btn{background:#888;color:black;}
.status-active{color:#00ff9d;}
.status-block{color:red;}
.status-expired{color:#00aaff;}
.hidden{display:none;}
.section-title{font-size:20px;font-weight:bold;margin-bottom:15px;color:#00ffff;}
.admin-box{background:#111122;border:1px solid #00ffff33;padding:15px;border-radius:12px;margin-top:20px;}
.balance{float:right;color:#00ff9d;font-weight:bold;}
table{width:100%;margin-top:10px;border-collapse:collapse;}
th,td{padding:6px;text-align:center;border-bottom:1px solid #222;font-size:12px;}
</style>
</head>

<body>

<header>
LR OWNER PANEL
<button id="logoutBtn" class="logout-top hidden" onclick="logout()">LOG OUT</button>
</header>

<div class="container">

<div class="card" id="loginSection">
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button class="owner-btn" onclick="login()">Login</button>
</div>

<div id="mainPanel" class="hidden">

<div class="card" id="generateSection">
<div class="section-title">GENERATE KEY</div>

<input type="text" id="username" placeholder="Username">
<input type="text" id="manualKey" placeholder="Manual Key (Optional)">
<input type="number" id="validity" placeholder="Validity Number">

<select id="validityType">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>

<button class="owner-btn" onclick="generateKey()">Generate Key</button>

<table>
<thead>
<tr>
<th>User</th><th>Key</th><th>Expire</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="keyTable"></tbody>
</table>
</div>

<div id="adminSection" class="card hidden">
<div class="section-title">ADMIN MANAGEMENT</div>
<div id="adminList"></div>
</div>

<div id="addAdminBox" class="card hidden">
<div class="section-title">ADD NEW ADMIN</div>
<input type="email" id="newAdminEmail" placeholder="Admin Email">
<input type="password" id="newAdminPassword" placeholder="Admin Password">
<button class="owner-btn" onclick="addAdmin()">Create Admin</button>
</div>

</div>
</div>

<script>

const client = supabase.createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6ImFub24i"
);

let currentUser;
let currentProfile;

/* SESSION PERSIST */
client.auth.getSession().then(({data})=>{
if(data.session){ initUser(); }
});

/* LOGIN */
async function login(){
const { error } = await client.auth.signInWithPassword({
email:loginEmail.value,
password:loginPassword.value
});
if(error){ alert(error.message); return; }
initUser();
}

/* INIT */
async function initUser(){
const { data:{user} } = await client.auth.getUser();
currentUser=user;

let { data } = await client.from("profiles").select("*").eq("id",user.id).single();
currentProfile=data;

if(!data || data.status==="blocked"){
alert("Access Denied");
logout();
return;
}

loginSection.classList.add("hidden");
mainPanel.classList.remove("hidden");
logoutBtn.classList.remove("hidden");

if(data.role==="owner"){
adminSection.classList.remove("hidden");
addAdminBox.classList.remove("hidden");
loadAdmins();
}

loadKeys();
}

/* LOGOUT */
async function logout(){
await client.auth.signOut();
location.reload();
}

/* RANDOM KEY */
function randomKey(){
return "LR-"+Math.floor(100000+Math.random()*900000);
}

/* GENERATE */
async function generateKey(){

let user=username.value;
let key=manualKey.value || randomKey();
let value=parseInt(validity.value);
let type=validityType.value;

if(!user||!value){ alert("Fill fields"); return; }

let cost = type==="days"? value*100 : value*10;

if(currentProfile.role==="admin"){
if(currentProfile.balance < cost){
let possible = Math.floor(currentProfile.balance/(type==="days"?100:10));
alert("Insufficient Balance. You can create only "+possible+" "+type);
return;
}
await client.from("profiles")
.update({balance: currentProfile.balance - cost})
.eq("id",currentUser.id);
currentProfile.balance -= cost;
}

let expire=new Date();
if(type==="days") expire.setDate(expire.getDate()+value);
else expire.setHours(expire.getHours()+value);

await client.from("license_keys").insert([{
username:user,
license_key:key,
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

loadKeys();
if(currentProfile.role==="owner") loadAdmins();
}

/* LOAD KEYS */
async function loadKeys(){
let { data } = await client.from("license_keys")
.select("*")
.eq("created_by",currentUser.id)
.order("id",{ascending:false});

keyTable.innerHTML="";

if(data){
data.forEach(k=>{
let expired = new Date(k.expire_date) < new Date();
let statusText = expired? "Expired" : k.status;
let statusClass = expired? "status-expired" : (k.status==="Active"?"status-active":"status-block");

keyTable.innerHTML+=`
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${expired?"Expired":new Date(k.expire_date).toLocaleString()}</td>
<td class="${statusClass}">${statusText}</td>
<td>
<button class="block-btn" onclick="toggleKey(${k.id},'${k.status}')">
${k.status==="Active"?"Block":"Unblock"}
</button>
<button class="danger-btn" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>`;
});
}
}

/* TOGGLE KEY */
async function toggleKey(id,status){
let newStatus=status==="Active"?"Blocked":"Active";
await client.from("license_keys").update({status:newStatus}).eq("id",id);
loadKeys();
if(currentProfile.role==="owner") loadAdmins();
}

/* DELETE KEY */
async function deleteKey(id){
if(!confirm("Delete?")) return;
await client.from("license_keys").delete().eq("id",id);
loadKeys();
if(currentProfile.role==="owner") loadAdmins();
}

/* LOAD ADMINS */
async function loadAdmins(){

let { data:admins } = await client.from("profiles")
.select("*")
.eq("role","admin");

adminList.innerHTML="";

if(admins){
for(let admin of admins){

let { data:keys } = await client.from("license_keys")
.select("*")
.eq("created_by",admin.id);

let total=keys?keys.length:0;
let active=keys?keys.filter(k=>k.status==="Active").length:0;
let blocked=keys?keys.filter(k=>k.status==="Blocked").length:0;

adminList.innerHTML+=`
<div class="admin-box">

<div>
${admin.email}
<span class="balance">â‚¹${admin.balance}</span>
</div>

Total: ${total} | Active: ${active} | Blocked: ${blocked}

<br><br>

<button class="block-btn" onclick="toggleAdmin('${admin.id}','${admin.status}')">
${admin.status==="blocked"?"Unblock":"Block"}
</button>

<button class="danger-btn" onclick="deleteAdmin('${admin.id}')">Delete</button>

</div>`;
}
}
}

/* TOGGLE ADMIN */
async function toggleAdmin(id,status){

let newStatus = status==="blocked"?"active":"blocked";

await client.from("profiles").update({status:newStatus}).eq("id",id);

if(newStatus==="blocked"){
await client.from("license_keys").update({status:"Blocked"}).eq("created_by",id);
}

loadAdmins();
}

/* DELETE ADMIN */
async function deleteAdmin(adminId){

if(!confirm("Delete Admin?")) return;

const { data: sessionData } = await client.auth.getSession();
const token = sessionData.session.access_token;

await fetch("https://dpskhodrzlnqczibolug.supabase.co/functions/v1/delete-admin",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+token
},
body:JSON.stringify({admin_id:adminId})
});

loadAdmins();
}

/* ADD ADMIN */
async function addAdmin(){

let email=newAdminEmail.value;
let password=newAdminPassword.value;

if(!email||!password){alert("Fill fields");return;}

let { data:existing } = await client.from("profiles").select("*").eq("email",email);

if(existing && existing.length>0){
alert("Admin already exists");
return;
}

const { data, error } = await client.auth.signUp({email,password});
if(error){ alert(error.message); return; }

await client.from("profiles").insert([{
id:data.user.id,
email:email,
role:"admin",
balance:1000,
status:"active"
}]);

alert("Admin Created");

newAdminEmail.value="";
newAdminPassword.value="";

loadAdmins();
}

</script>
</body>
</html>
