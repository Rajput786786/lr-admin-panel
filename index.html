<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR CONTROL PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#050510,#0f0f1f);
color:white;
}

.title{
text-align:center;
font-size:32px;
font-weight:bold;
color:#00ffff;
text-shadow:0 0 15px #00ffff;
margin:25px 0;
}

.glass{
background:rgba(255,255,255,0.05);
backdrop-filter:blur(15px);
border:1px solid rgba(0,255,255,0.2);
box-shadow:0 0 30px rgba(0,255,255,0.15);
border-radius:18px;
padding:25px;
margin-bottom:30px;
}

input,select{
width:100%;
padding:12px;
margin:8px 0;
background:transparent;
border:none;
border-bottom:2px solid #00ffff;
color:white;
outline:none;
}

button{
padding:10px 18px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:bold;
margin:5px;
}

.btn-primary{background:#00ffff;color:black;}
.btn-danger{background:red;color:white;}
.btn-block{background:#888;color:black;}
.btn-logout{background:red;color:white;float:right;}

.hidden{display:none;}

table{
width:100%;
margin-top:15px;
border-collapse:collapse;
}

th,td{
padding:8px;
text-align:center;
border-bottom:1px solid rgba(255,255,255,0.1);
font-size:13px;
}

.green{color:#00ff9d;}
.red{color:red;}
.blue{color:#00ccff;}

.admin-box{
margin-top:25px;
padding:20px;
border-radius:15px;
background:rgba(0,0,0,0.4);
border:1px solid rgba(0,255,255,0.3);
}

.balance{
float:right;
color:#00ff9d;
font-weight:bold;
}

.clear{clear:both;}
.center{text-align:center;}
</style>
</head>

<body>

<div class="title">LR CONTROL PANEL</div>

<div id="loginBox" class="glass" style="max-width:400px;margin:50px auto;">
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button id="loginBtn" class="btn-primary">LOGIN</button>
</div>

<div id="panel" class="hidden" style="max-width:1200px;margin:auto;">
<button class="btn-logout" onclick="logout()">LOG OUT</button>
<div class="clear"></div>

<div id="ownerSection"></div>
<div id="adminSections"></div>

<div id="addAdminBox" class="glass hidden center">
<h3>Add New Admin</h3>
<input type="email" id="newEmail" placeholder="Admin Email">
<input type="password" id="newPassword" placeholder="Admin Password">
<button id="addAdminBtn" class="btn-primary">CREATE ADMIN</button>
</div>

</div>

<script>

const supabaseClient = window.supabase.createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs"
);

let currentUser = null;
let currentProfile = null;

/* ===== LOGIN HANDLER ===== */
document.getElementById("loginBtn").addEventListener("click", async () => {

const email = document.getElementById("loginEmail").value.trim();
const password = document.getElementById("loginPassword").value.trim();

if(!email || !password){
alert("Enter Email & Password");
return;
}

const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

if(error){
alert(error.message);
return;
}

initSession();
});

/* ===== SESSION CHECK ===== */
supabaseClient.auth.getSession().then(({data})=>{
if(data.session){
initSession();
}
});

/* ===== INIT SESSION ===== */
async function initSession(){

const { data:{ user } } = await supabaseClient.auth.getUser();
currentUser = user;

const { data, error } = await supabaseClient
.from("profiles")
.select("*")
.eq("id", user.id)
.single();

if(error){
alert("Profile not found");
await logout();
return;
}

if(data.status === "blocked"){
alert("You are blocked");
await logout();
return;
}

currentProfile = data;

document.getElementById("loginBox").classList.add("hidden");
document.getElementById("panel").classList.remove("hidden");

loadPanel();
}

/* ===== LOGOUT ===== */
async function logout(){
await supabaseClient.auth.signOut();
location.reload();
}

/* ===== PANEL LOAD ===== */
async function loadPanel(){

document.getElementById("ownerSection").innerHTML="";
document.getElementById("adminSections").innerHTML="";

if(currentProfile.role === "owner"){
document.getElementById("addAdminBox").classList.remove("hidden");
await loadAllKeys();
await loadAdmins();
}else{
document.getElementById("addAdminBox").classList.add("hidden");
await loadOwnKeys();
}
}

/* ===== OWNER ALL KEYS ===== */
async function loadAllKeys(){

const { data } = await supabaseClient
.from("license_keys")
.select("*")
.order("id",{ascending:false});

let html = `<div class="glass"><h3>All Keys</h3>
<table>
<tr><th>User</th><th>Key</th><th>Expire</th><th>Status</th><th>Action</th></tr>`;

data.forEach(k=>{
let expired = new Date(k.expire_date) < new Date();
let status = expired ? "Expired" : k.status;
let cls = expired ? "blue" : (k.status==="Active"?"green":"red");

html += `<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${expired ? "Expired" : new Date(k.expire_date).toLocaleString()}</td>
<td class="${cls}">${status}</td>
<td>
<button class="btn-block" onclick="toggleKey(${k.id},'${k.status}')">Toggle</button>
<button class="btn-danger" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>`;
});

html += "</table></div>";

document.getElementById("ownerSection").innerHTML = html;
}

/* ===== ADMIN OWN KEYS ===== */
async function loadOwnKeys(){

const { data } = await supabaseClient
.from("license_keys")
.select("*")
.eq("created_by", currentUser.id)
.order("id",{ascending:false});

let html = `<div class="glass"><h3>Your Keys</h3>
<table>
<tr><th>User</th><th>Key</th><th>Expire</th><th>Status</th></tr>`;

data.forEach(k=>{
let expired = new Date(k.expire_date) < new Date();
let status = expired ? "Expired" : k.status;

html += `<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${expired ? "Expired" : new Date(k.expire_date).toLocaleString()}</td>
<td>${status}</td>
</tr>`;
});

html += "</table></div>";

document.getElementById("adminSections").innerHTML = html;
}

/* ===== TOGGLE KEY ===== */
async function toggleKey(id,status){

let newStatus = status==="Active" ? "Blocked" : "Active";

await supabaseClient
.from("license_keys")
.update({status:newStatus})
.eq("id", id);

loadPanel();
}

/* ===== DELETE KEY ===== */
async function deleteKey(id){
if(!confirm("Delete?")) return;

await supabaseClient
.from("license_keys")
.delete()
.eq("id", id);

loadPanel();
}

/* ===== LOAD ADMINS ===== */
async function loadAdmins(){

const { data } = await supabaseClient
.from("profiles")
.select("*")
.eq("role","admin");

for(let admin of data){

const { data:keys } = await supabaseClient
.from("license_keys")
.select("*")
.eq("created_by", admin.id);

let total = keys.length;
let active = keys.filter(k=>k.status==="Active").length;
let blocked = keys.filter(k=>k.status==="Blocked").length;

let box = `<div class="admin-box">
<b>${admin.email}</b>
<span class="balance">â‚¹${admin.balance}</span><br>
Total:${total} | Active:${active} | Blocked:${blocked}<br><br>

<button class="btn-block" onclick="toggleAdmin('${admin.id}','${admin.status}')">
${admin.status==="blocked"?"Unblock":"Block"}
</button>

<button class="btn-danger" onclick="deleteAdmin('${admin.id}')">Delete</button>

</div>`;

document.getElementById("adminSections").innerHTML += box;
}
}

/* ===== TOGGLE ADMIN ===== */
async function toggleAdmin(id,status){

let newStatus = status==="blocked" ? "active" : "blocked";

await supabaseClient
.from("profiles")
.update({status:newStatus})
.eq("id", id);

if(newStatus==="blocked"){
await supabaseClient
.from("license_keys")
.update({status:"Blocked"})
.eq("created_by", id);
}

loadPanel();
}

/* ===== DELETE ADMIN ===== */
async function deleteAdmin(adminId){

if(!confirm("Delete Admin?")) return;

const { data:session } = await supabaseClient.auth.getSession();

await fetch("https://dpskhodrzlnqczibolug.supabase.co/functions/v1/delete-admin",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+session.session.access_token
},
body:JSON.stringify({admin_id:adminId})
});

loadPanel();
}

/* ===== ADD ADMIN ===== */
document.getElementById("addAdminBtn").addEventListener("click", async ()=>{

const email = document.getElementById("newEmail").value.trim();
const password = document.getElementById("newPassword").value.trim();

if(!email || !password){
alert("Fill all fields");
return;
}

const { data:exist } = await supabaseClient
.from("profiles")
.select("*")
.eq("email", email);

if(exist.length>0){
alert("Admin already exists");
return;
}

const { data, error } = await supabaseClient.auth.signUp({ email, password });

if(error){
alert(error.message);
return;
}

await supabaseClient.from("profiles").insert([{
id:data.user.id,
email,
role:"admin",
balance:1000,
status:"active"
}]);

alert("Admin Added");

loadPanel();
});

</script>

</body>
</html>
