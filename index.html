<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LR OWNER PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;}

body{
margin:0;
font-family:Segoe UI,Arial,sans-serif;
background:radial-gradient(circle at center,#700000 0%,#2a0000 45%,#0d0000 100%);
color:white;
overflow-x:hidden;
}

.container{
max-width:480px;
margin:auto;
padding:18px;
}

.title{
text-align:center;
font-size:26px;
font-weight:bold;
color:#ff2a2a;
text-shadow:0 0 25px red;
margin:15px 0;
}

.logout{
float:right;
background:#ff1a1a;
color:white;
border:none;
padding:8px 18px;
border-radius:14px;
box-shadow:0 0 18px red;
font-weight:bold;
}

.card{
background:linear-gradient(145deg,#400000,#1a0000);
border:2px solid rgba(255,0,0,0.6);
border-radius:24px;
padding:22px;
margin-top:22px;
box-shadow:
0 0 35px rgba(255,0,0,0.5),
inset 0 0 25px rgba(255,0,0,0.15);
}

/* ===== GENERATE SECTION (UNCHANGED LOOK) ===== */

input,select{
width:100%;
padding:14px;
margin:12px 0;
background:linear-gradient(145deg,#300000,#1a0000);
border:1px solid #ff2a2a;
border-radius:16px;
color:white;
font-size:15px;
outline:none;
box-shadow:
inset 0 0 12px rgba(255,0,0,0.4),
0 0 8px rgba(255,0,0,0.4);
}

.btn{
background:linear-gradient(145deg,#ff1a1a,#c40000);
border:none;
color:white;
padding:12px 22px;
border-radius:18px;
box-shadow:0 0 20px red;
font-weight:bold;
margin-top:10px;
}

/* ===== TABLE FIXED PROPER ALIGNMENT ===== */

table{
width:100%;
table-layout:fixed;
border-collapse:collapse;
margin-top:12px;
}

th,td{
white-space:nowrap;
font-size:11px;
padding:10px 4px;
text-align:center;
border-bottom:1px solid rgba(255,255,255,0.15);
line-height:1.4;
overflow:hidden;
}

th{
color:#ff4d4d;
font-size:12px;
}

/* COLUMN WIDTH BALANCE */
th:nth-child(1), td:nth-child(1){width:16%;}
th:nth-child(2), td:nth-child(2){width:22%;}
th:nth-child(3), td:nth-child(3){width:22%;}
th:nth-child(4), td:nth-child(4){width:14%;}
th:nth-child(5), td:nth-child(5){width:12%;}
th:nth-child(6), td:nth-child(6){width:14%;}

.green{color:#00ff9d;}
.red{color:red;}
.blue{color:#00ccff;}

.action-btn{
padding:6px 8px;
border-radius:6px;
border:none;
font-size:10px;
font-weight:bold;
min-width:55px;
margin:2px 0;
box-shadow:0 0 8px rgba(255,0,0,0.4);
}

.block-btn{
background:linear-gradient(145deg,#b3b3b3,#8c8c8c);
color:black;
}

.delete-btn{
background:linear-gradient(145deg,#ff1a1a,#c40000);
color:white;
}

.hidden{display:none;}
.clear{clear:both;}

</style>
</head>

<body>

<div class="container">

<div class="title">LR OWNER PANEL</div>

<div id="loginBox" class="card">
<input type="email" id="loginEmail" placeholder="Owner Email">
<input type="password" id="loginPassword" placeholder="Password">
<button id="loginBtn" class="btn" style="width:100%;">LOGIN</button>
</div>

<div id="panel" class="hidden">
<button class="logout" onclick="logout()">LOG OUT</button>
<div class="clear"></div>
<div id="content"></div>
</div>

</div>

<script>

/* ===== LOGIC 100% SAME ===== */

const supabaseClient = window.supabase.createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs"
);

let currentUser=null;
let profile=null;

document.getElementById("loginBtn").addEventListener("click", async ()=>{
const email=loginEmail.value.trim();
const password=loginPassword.value.trim();
if(!email||!password){alert("Enter Email & Password");return;}
const {error}=await supabaseClient.auth.signInWithPassword({email,password});
if(error){alert(error.message);return;}
loadSession();
});

supabaseClient.auth.getSession().then(({data})=>{
if(data.session) loadSession();
});

async function loadSession(){
const {data:{user}}=await supabaseClient.auth.getUser();
if(!user)return;
currentUser=user;

const {data,error}=await supabaseClient
.from("profiles").select("*").eq("id",user.id).single();

if(error){alert("Profile error");return;}
if(data.role!=="owner"){alert("Access Denied");await logout();return;}
if(data.status==="blocked"){alert("Blocked");await logout();return;}

profile=data;
loginBox.classList.add("hidden");
panel.classList.remove("hidden");
renderPanel();
}

async function logout(){
await supabaseClient.auth.signOut();
location.reload();
}

function isExpired(d){return new Date(d)<new Date();}

async function renderPanel(){

let html="";

html+=`
<div class="card">
<h3 style="font-size:20px;">Generate Key</h3>
<input type="text" id="username" placeholder="Username">
<input type="text" id="manualKey" placeholder="Manual Key (Optional)">
<input type="number" id="validity" placeholder="Validity">
<select id="type">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<input type="number" id="maxDevices" placeholder="Devices">
<button class="btn" onclick="generateKey()">Generate</button>
</div>`;

const {data:keys}=await supabaseClient
.from("license_keys")
.select("*")
.eq("created_by",currentUser.id)
.order("id",{ascending:false});

html+=`<div class="card">
<h3 style="font-size:20px;">Your Keys</h3>
<table>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Devices</th>
<th>Action</th>
</tr>`;

keys.forEach(k=>{
let expired=isExpired(k.expire_date);
let status=expired?"Expired":k.status;
let cls=expired?"blue":(k.status==="Active"?"green":"red");

html+=`<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${expired?"Expired":new Date(k.expire_date).toLocaleString()}</td>
<td class="${cls}">${status}</td>
<td>${k.used_devices || 0} / ${k.max_devices || 1}</td>
<td>
<button class="action-btn block-btn" onclick="toggleKey(${k.id},'${k.status}')">
${k.status==="Active"?"Block":"Unblock"}
</button>
<button class="action-btn delete-btn" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>`;
});

html+="</table></div>";

content.innerHTML=html;
}

async function generateKey(){
const u=username.value.trim();
const m=manualKey.value.trim();
const v=parseInt(validity.value);
const t=type.value;
const maxDev=parseInt(maxDevices.value)||1;
if(!u||!v){alert("Fill fields");return;}
let key=m||("LR-"+Math.floor(100000+Math.random()*900000));
let expire=new Date();
if(t==="days")expire.setDate(expire.getDate()+v);
else expire.setHours(expire.getHours()+v);
await supabaseClient.from("license_keys").insert([{
username:u,
license_key:key,
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id,
max_devices:maxDev,
used_devices:0
}]);
renderPanel();
}

async function toggleKey(id,status){
const {data}=await supabaseClient.from("license_keys")
.select("expire_date").eq("id",id).single();
if(isExpired(data.expire_date)){
alert("Expired key cannot be activated");
return;
}
await supabaseClient.from("license_keys")
.update({status:status==="Active"?"Blocked":"Active"})
.eq("id",id);
renderPanel();
}

async function deleteKey(id){
if(!confirm("Delete?"))return;
await supabaseClient.from("license_keys").delete().eq("id",id);
renderPanel();
}

</script>
</body>
</html>
