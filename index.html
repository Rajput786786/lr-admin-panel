<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LR OWNER PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
background:linear-gradient(135deg,#0a0f1e,#141b33);
color:#e0e7ff;
font-family:Arial,Helvetica,sans-serif;
padding:20px;
}
.hidden{display:none}
.card{
background:rgba(18,28,50,.8);
padding:20px;
border-radius:20px;
margin-bottom:20px;
}
button{
padding:8px 16px;
border-radius:20px;
cursor:pointer;
border:none;
}
input,select{
padding:8px;
border-radius:10px;
border:none;
margin:4px 0;
}
table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}
td,th{
padding:8px;
border-bottom:1px solid #2e4970;
}
</style>
</head>

<body>

<div id="loginBox" class="card">
<h2>LR OWNER LOGIN</h2>
<input id="email" type="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
</div>

<div id="panel" class="hidden">

<div class="card">
<h2 id="panelTitle"></h2>
<button onclick="logout()">Logout</button>
</div>

<div id="ownerSection" class="hidden card">
<h3>Generate Key (Owner)</h3>
<input id="o_user" placeholder="Username">
<input id="o_valid" type="number" value="1">
<select id="o_type">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button onclick="generateKey(true)">Generate</button>
<div id="ownerKeys"></div>
<hr>
<h3>Add Admin</h3>
<input id="newEmail" placeholder="Admin Email">
<input id="newPass" placeholder="Password">
<button onclick="addAdmin()">Add</button>
<div id="adminList"></div>
</div>

<div id="adminSection" class="hidden card">
<h3>Generate Key (Admin)</h3>
<div id="balanceBox"></div>
<input id="a_user" placeholder="Username">
<input id="a_valid" type="number" value="1">
<select id="a_type">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button onclick="generateKey(false)">Generate</button>
<div id="adminKeys"></div>
</div>

</div>

<script>

const supabase = window.supabase.createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs"
);

let currentUser=null;

window.onload=async()=>{
const {data}=await supabase.auth.getSession();
if(data.session?.user) loadUser(data.session.user.id);
};

async function login(){
const {error}=await supabase.auth.signInWithPassword({
email:email.value,
password:password.value
});
if(error) alert(error.message);
else{
const {data}=await supabase.auth.getSession();
loadUser(data.session.user.id);
}
}

async function loadUser(id){
const {data}=await supabase.from("profiles").select("*").eq("id",id).single();
if(!data) return;
if(data.is_blocked){alert("Blocked");logout();return;}
currentUser=data;
loginBox.classList.add("hidden");
panel.classList.remove("hidden");
panelTitle.innerText=data.role.toUpperCase()+" PANEL";
if(data.role==="owner"){
ownerSection.classList.remove("hidden");
adminSection.classList.add("hidden");
loadOwner();
}else{
adminSection.classList.remove("hidden");
ownerSection.classList.add("hidden");
loadAdmin();
}
}

async function logout(){
await supabase.auth.signOut();
location.reload();
}

function randomKey(){
return "LR-"+Math.random().toString(36).substring(2,8).toUpperCase();
}

async function generateKey(isOwner){
const user=isOwner?o_user.value:a_user.value;
const val=Number(isOwner?o_valid.value:a_valid.value);
const type=isOwner?o_type.value:a_type.value;
if(!val||val<1) return alert("Invalid");

let cost=type==="days"?val*100:val*10;
if(!isOwner && currentUser.balance<cost)
return alert("Insufficient Balance");

let exp=new Date();
if(type==="days") exp.setDate(exp.getDate()+val);
else exp.setHours(exp.getHours()+val);

await supabase.from("license_keys").insert({
username:user,
license_key:randomKey(),
expire_date:exp,
status:"Active",
created_by:currentUser.id,
key_type:type
});

if(!isOwner){
await supabase.from("profiles")
.update({balance:currentUser.balance-cost})
.eq("id",currentUser.id);
}

location.reload();
}

async function loadOwner(){
loadKeys();
const {data}=await supabase.from("profiles").select("*").eq("role","admin");
adminList.innerHTML="<h4>Admins</h4>";
data.forEach(a=>{
adminList.innerHTML+=a.email+
" | ₹"+a.balance+
" <button onclick='blockAdmin(\""+a.id+"\")'>Block</button>"+
" <button onclick='deleteAdmin(\""+a.id+"\")'>Delete</button><br>";
});
}

async function loadAdmin(){
balanceBox.innerText="Balance ₹"+currentUser.balance;
loadKeys();
}

async function loadKeys(){
const {data}=await supabase.from("license_keys")
.select("*")
.eq("created_by",currentUser.id);

let box=currentUser.role==="owner"?ownerKeys:adminKeys;
box.innerHTML="";
box.innerHTML="<table><tr><th>User</th><th>Key</th><th>Status</th></tr>";
data.forEach(k=>{
box.innerHTML+="<tr><td>"+k.username+"</td><td>"+k.license_key+"</td><td>"+k.status+"</td></tr>";
});
box.innerHTML+="</table>";
}

async function blockAdmin(id){
await supabase.from("profiles")
.update({is_blocked:true,status:"blocked"})
.eq("id",id);
await supabase.from("license_keys")
.update({status:"Blocked"})
.eq("created_by",id);
location.reload();
}

async function deleteAdmin(id){
await fetch("https://dpskhodrzlnqczibolug.functions.supabase.co/delete-admin",{
method:"POST",
headers:{
"Content-Type":"application/json",
"Authorization":"Bearer "+(await supabase.auth.getSession()).data.session.access_token
},
body:JSON.stringify({admin_id:id})
});
location.reload();
}

async function addAdmin(){
const {data,error}=await supabase.auth.signUp({
email:newEmail.value,
password:newPass.value
});
if(error) return alert(error.message);
await supabase.from("profiles").insert({
id:data.user.id,
email:newEmail.value,
role:"admin",
balance:1000,
status:"active",
is_blocked:false
});
location.reload();
}

</script>
</body>
</html>
