<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR Control Panel</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f1a;color:white;}
header{padding:20px;text-align:center;font-size:24px;background:#111;color:#00ffff;}
.container{padding:20px;}

.card{
background:#1a1a2e;
padding:20px;
border-radius:10px;
margin-bottom:20px;
box-shadow:0 0 15px rgba(0,255,255,0.2);
}

.owner-title{color:#00ffff;}
.admin-title{color:#39ffb6;}

input{
padding:10px;
margin:5px 0;
width:100%;
border:none;
border-radius:5px;
background:#111;
color:white;
}

button{
padding:10px;
margin-top:10px;
border:none;
border-radius:5px;
font-weight:bold;
cursor:pointer;
}

.owner-btn{width:100%;background:#00ffff;color:black;}
.admin-btn{width:100%;background:#39ffb6;color:black;}
.block-btn{background:#999;color:black;}
.delete-btn{background:red;color:white;margin-left:5px;}
.logout-btn{background:red;color:white;width:100%;}

table{width:100%;margin-top:15px;border-collapse:collapse;}
th,td{padding:10px;text-align:center;border-bottom:1px solid #333;}
.status-active{color:#00ff88;}
.status-block{color:red;}
.balance-box{margin-top:10px;font-weight:bold;}
</style>
</head>

<body>

<header>LR CONTROL PANEL</header>

<div class="container">

<div class="card" id="loginSection">
<h3>Login</h3>
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button class="owner-btn" onclick="login()">Login</button>
</div>

<div id="mainPanel" style="display:none;">

<div class="card">
<button class="logout-btn" onclick="logout()">Logout</button>
<div class="balance-box" id="balanceInfo"></div>
</div>

<!-- OWNER PANEL -->
<div class="card" id="ownerPanel" style="display:none;">
<h3 class="owner-title">OWNER PANEL</h3>

<input type="text" id="ownerUsername" placeholder="User Name">
<input type="number" id="ownerDays" placeholder="Validity (Days)">
<button class="owner-btn" onclick="generateOwnerKey()">Generate Owner Key</button>

<h4>Owner Keys</h4>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="ownerTable"></tbody>
</table>
</div>

<!-- ADMIN PANEL -->
<div class="card" id="adminPanel" style="display:none;">
<h3 class="admin-title">ADMIN PANEL</h3>

<input type="text" id="adminUsername" placeholder="User Name">
<input type="number" id="adminDays" placeholder="Validity (Days)">
<button class="admin-btn" onclick="generateAdminKey()">Generate Admin Key</button>

<h4>Admin Keys</h4>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

</div>
</div>

<script>

const { createClient } = supabase;

const client = createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"sb_publishable_slJiDSH_dv0jCErcO8j0-A__ebbJItK"
);

let currentUser=null;
let currentProfile=null;

document.addEventListener("DOMContentLoaded", async () => {
const { data } = await client.auth.getSession();
if(data.session){
currentUser=data.session.user;
await loadProfile();
showPanel();
}
});

async function login(){
let email=loginEmail.value.trim();
let password=loginPassword.value.trim();
const { error }=await client.auth.signInWithPassword({email,password});
if(error){alert(error.message);return;}
location.reload();
}

async function logout(){
await client.auth.signOut();
location.reload();
}

async function loadProfile(){
const { data }=await client.from("profiles").select("*").eq("id",currentUser.id).single();
currentProfile=data;

balanceInfo.innerText="Balance: "+data.balance;

if(data.role==="owner"){
ownerPanel.style.display="block";
adminPanel.style.display="block";
}else{
adminPanel.style.display="block";
}
loadKeys();
}

function showPanel(){
loginSection.style.display="none";
mainPanel.style.display="block";
}

function randomKey(){
return "LR-"+Math.floor(Math.random()*1000000);
}

async function generateOwnerKey(){
let user=ownerUsername.value.trim();
let days=parseInt(ownerDays.value);
if(!user||isNaN(days))return alert("Fill all fields");

let expire=new Date(Date.now()+days*24*60*60*1000);

await client.from("license_keys").insert([{
username:user,
license_key:randomKey(),
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

loadKeys();
ownerUsername.value="";
ownerDays.value="";
}

async function generateAdminKey(){
if(currentProfile.balance<=0)return alert("Balance Low");

let user=adminUsername.value.trim();
let days=parseInt(adminDays.value);
if(!user||isNaN(days))return alert("Fill all fields");

let expire=new Date(Date.now()+days*24*60*60*1000);

await client.from("license_keys").insert([{
username:user,
license_key:randomKey(),
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

await client.from("profiles")
.update({balance:currentProfile.balance-1})
.eq("id",currentUser.id);

loadProfile();
adminUsername.value="";
adminDays.value="";
}

async function loadKeys(){

let { data }=await client.from("license_keys").select("*").order("id",{ascending:false});

ownerTable.innerHTML="";
adminTable.innerHTML="";

data.forEach(k=>{

let formatted=new Date(k.expire_date).toLocaleString("en-IN",{
day:"2-digit",
month:"2-digit",
year:"numeric",
hour:"2-digit",
minute:"2-digit",
hour12:true
});

let row=`
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${formatted}</td>
<td class="${k.status==="Active"?"status-active":"status-block"}">${k.status}</td>
<td>
<button class="block-btn" onclick="toggleStatus(${k.id},'${k.status}')">
${k.status==="Active"?"Block":"Unblock"}
</button>
<button class="delete-btn" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>`;

if(currentProfile.role==="owner"){
if(k.created_by===currentUser.id){
ownerTable.innerHTML+=row;
}else{
adminTable.innerHTML+=row;
}
}else{
if(k.created_by===currentUser.id){
adminTable.innerHTML+=row;
}
}
});
}

async function toggleStatus(id,current){
let newStatus=current==="Active"?"Blocked":"Active";
await client.from("license_keys").update({status:newStatus}).eq("id",id);
loadKeys();
}

async function deleteKey(id){
if(!confirm("Delete this key?"))return;
await client.from("license_keys").delete().eq("id",id);
loadKeys();
}

</script>
</body>
</html>
