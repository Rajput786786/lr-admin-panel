<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LR CONTROL PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#0f0f1a;color:white;}
header{padding:25px;text-align:center;font-size:30px;background:#111;color:#00f5ff;font-weight:bold;letter-spacing:2px;}
.container{padding:20px;max-width:1200px;margin:auto;}
.card{background:#151528;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:0 0 15px #00f5ff22;}
.owner-title{font-size:26px;color:#00f5ff;font-weight:bold;margin-bottom:15px;}
.admin-title{font-size:22px;color:#00ff9d;font-weight:bold;margin-bottom:10px;}
.admin-email{font-size:16px;color:#ff5c5c;margin-bottom:15px;}
.balance{font-size:18px;color:#00ff9d;font-weight:bold;margin-bottom:10px;}
.stats{margin:10px 0;}
.stats div{margin:3px 0;}
input,select{
padding:10px;margin:6px 0;width:100%;
border:none;border-radius:6px;background:#0d0d18;color:white;
}
button{
padding:8px 14px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;
}
.btn-main{background:#00f5ff;color:black;}
.btn-admin{background:#00ff9d;color:black;}
.btn-danger{background:red;color:white;}
.btn-gray{background:#888;color:black;}
table{width:100%;margin-top:10px;border-collapse:collapse;}
th,td{padding:8px;text-align:center;border-bottom:1px solid #222;}
.status-active{color:#00ff9d;}
.status-block{color:red;}
.hidden{display:none;}
.logout{background:red;color:white;width:100%;}
</style>
</head>

<body>

<header>LR OWNER PANEL</header>

<div class="container">

<div class="card" id="loginBox">
<h3>Login</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button class="btn-main" onclick="login()">Login</button>
</div>

<div id="mainPanel" class="hidden">

<div class="card">
<button class="logout" onclick="logout()">Logout</button>
</div>

<!-- OWNER PANEL -->
<div id="ownerPanel" class="hidden card">
<div class="owner-title">OWNER PANEL</div>

<input type="text" id="ownerUser" placeholder="User">
<input type="text" id="ownerKey" placeholder="Manual Key (Optional)">
<input type="number" id="ownerValue" placeholder="Validity Number">
<select id="ownerType">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button class="btn-main" onclick="generateKey()">Generate Key</button>

<h4 style="margin-top:20px;">All Keys</h4>
<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="ownerTable"></tbody>
</table>

<h4 style="margin-top:30px;">Admins</h4>
<div id="adminList"></div>

</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden"></div>

</div>
</div>

<script>

const client = supabase.createClient(
"https://dpskhodrzlnqczibolug.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwc2tob2RyemxucWN6aWJvbHVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjU1MTcsImV4cCI6MjA4NzYwMTUxN30.53CxPWtg_-PpDt_reNsxE1A4KupdhFfv6wbB3HsuhNs"
);

let currentUser, currentProfile;

async function login(){
let { error } = await client.auth.signInWithPassword({
email:email.value,
password:password.value
});
if(error){ alert(error.message); return; }

let { data } = await client.from("profiles").select("*")
.eq("id",(await client.auth.getUser()).data.user.id).single();

if(data.status==="blocked"){ alert("Blocked"); logout(); return; }

currentUser=(await client.auth.getUser()).data.user;
currentProfile=data;

loginBox.classList.add("hidden");
mainPanel.classList.remove("hidden");

if(data.role==="owner"){
ownerPanel.classList.remove("hidden");
loadOwner();
}else{
loadAdmin();
}
}

async function logout(){
await client.auth.signOut();
location.reload();
}

function randomKey(){
return "LR-"+Math.floor(100000+Math.random()*900000);
}

async function generateKey(){

let user=ownerUser.value;
let manual=ownerKey.value;
let val=parseInt(ownerValue.value);
let type=ownerType.value;

if(!user||!val) return alert("Fill fields");

let expire=new Date();

if(type==="days") expire.setDate(expire.getDate()+val);
else expire.setHours(expire.getHours()+val);

await client.from("license_keys").insert([{
username:user,
license_key:manual?manual:randomKey(),
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

loadOwner();
}

async function loadOwner(){

let { data } = await client.from("license_keys")
.select("*").order("id",{ascending:false});

ownerTable.innerHTML="";
data.forEach(k=>{
ownerTable.innerHTML+=row(k,true);
});

let { data:admins } = await client.from("profiles")
.select("*").eq("role","admin");

adminList.innerHTML="";
admins.forEach(a=>{
adminList.innerHTML+=`
<div class="card">
<div class="admin-title">ADMIN PANEL</div>
<div class="admin-email">${a.email}</div>
<div class="balance">Balance ₹ ${a.balance}</div>
<div class="stats">
<div>Total Key</div>
<div>Active Key</div>
<div>Block Key</div>
</div>
<button class="btn-gray" onclick="toggleAdmin('${a.id}','${a.status}')">
${a.status==="active"?"Block Admin":"Unblock Admin"}
</button>
<button class="btn-danger" onclick="deleteAdmin('${a.id}')">Delete Admin</button>
</div>
`;
});
}

async function loadAdmin(){

adminPanel.classList.remove("hidden");

let { data:keys } = await client.from("license_keys")
.select("*").eq("created_by",currentUser.id);

let total=keys.length;
let active=keys.filter(k=>k.status==="Active").length;
let block=keys.filter(k=>k.status==="Blocked").length;

adminPanel.innerHTML=`
<div class="card">
<div class="admin-title">ADMIN PANEL</div>
<div class="admin-email">${currentProfile.email}</div>
<div class="balance">Balance ₹ ${currentProfile.balance}</div>

<div class="stats">
<div>Total Key ${total}</div>
<div>Active Key ${active}</div>
<div>Block Key ${block}</div>
</div>

<input type="text" id="adminUser" placeholder="User">
<input type="text" id="adminManual" placeholder="Manual Key (Optional)">
<input type="number" id="adminValue" placeholder="Validity Number">
<select id="adminType">
<option value="days">Days</option>
<option value="hours">Hours</option>
</select>
<button class="btn-admin" onclick="adminGenerate()">Generate Key</button>

<table>
<thead>
<tr>
<th>User</th>
<th>Key</th>
<th>Expire</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>
`;

let table=document.getElementById("adminTable");
keys.forEach(k=> table.innerHTML+=row(k,false));
}

async function adminGenerate(){

let user=adminUser.value;
let manual=adminManual.value;
let val=parseInt(adminValue.value);
let type=adminType.value;

if(!user||!val) return alert("Fill");

let cost=(type==="days")?val*100:val*10;
if(currentProfile.balance<cost) return alert("Low Balance");

let expire=new Date();
if(type==="days") expire.setDate(expire.getDate()+val);
else expire.setHours(expire.getHours()+val);

await client.from("license_keys").insert([{
username:user,
license_key:manual?manual:randomKey(),
expire_date:expire.toISOString(),
status:"Active",
created_by:currentUser.id
}]);

await client.from("profiles")
.update({balance:currentProfile.balance-cost})
.eq("id",currentUser.id);

loadAdmin();
}

function row(k,isOwner){
return `
<tr>
<td>${k.username}</td>
<td>${k.license_key}</td>
<td>${new Date(k.expire_date).toLocaleString("en-IN",{hour12:true})}</td>
<td class="${k.status==="Active"?"status-active":"status-block"}">${k.status}</td>
<td>
<button class="btn-gray" onclick="toggleKey(${k.id},'${k.status}')">
${k.status==="Active"?"Block":"Unblock"}
</button>
<button class="btn-danger" onclick="deleteKey(${k.id})">Delete</button>
</td>
</tr>
`;
}

async function toggleKey(id,status){
let newStatus=status==="Active"?"Blocked":"Active";
await client.from("license_keys").update({status:newStatus}).eq("id",id);
if(currentProfile.role==="owner") loadOwner(); else loadAdmin();
}

async function deleteKey(id){
await client.from("license_keys").delete().eq("id",id);
if(currentProfile.role==="owner") loadOwner(); else loadAdmin();
}

async function toggleAdmin(id,status){
let newStatus=status==="active"?"blocked":"active";
await client.from("profiles").update({status:newStatus}).eq("id",id);
if(newStatus==="blocked"){
await client.from("license_keys").update({status:"Blocked"}).eq("created_by",id);
}
loadOwner();
}

async function deleteAdmin(id){
await client.from("license_keys").delete().eq("created_by",id);
await client.from("profiles").delete().eq("id",id);
loadOwner();
}

</script>
</body>
</html>
